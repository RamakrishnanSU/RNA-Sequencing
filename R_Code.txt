# Load necessary libraries
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
required_packages <- c("DESeq2", "ggplot2", "pheatmap", "clusterProfiler", "org.Hs.eg.db", "apeglm", "readxl")
for (pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) BiocManager::install(pkg)
}
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(clusterProfiler)
library(org.Hs.eg.db)
library(apeglm)
library(readxl)

setwd("C:/Users/ramak/Desktop/R/R")

# Load the Excel file
count_matrix <- read_excel("counts_1.xlsx", sheet = 1)

# Convert to a data frame
count_matrix <- as.data.frame(count_matrix)

# Set the second row as column names (assuming it's the header)
colnames(count_matrix) <- count_matrix[1, ]
count_matrix <- count_matrix[-1, ]

# Replace missing values in the 'Geneid' column with unique identifiers
count_matrix$Geneid[is.na(count_matrix$Geneid)] <- paste0("Gene_", seq_len(sum(is.na(count_matrix$Geneid))))

# Ensure 'Geneid' values are unique
count_matrix$Geneid <- make.unique(as.character(count_matrix$Geneid))

# Set the 'Geneid' column as row names
rownames(count_matrix) <- count_matrix$Geneid
count_matrix <- count_matrix[, -1]

# Subset only relevant numeric columns (adjust column indices as needed)
count_matrix <- count_matrix[, 6:17]

# Convert data to numeric while preserving row names
count_matrix[] <- lapply(count_matrix, as.numeric)

head(rownames(count_matrix))  # Should display gene names
head(colnames(count_matrix))  # Should display sample names

# Load sample information
sample_info <- data.frame(
  sample = c("TNBC1", "TNBC2", "TNBC3",
             "Normal1", "Normal2", "Normal3",
             "NonTNBC1", "NonTNBC2", "NonTNBC3",
             "HER21", "HER22", "HER23"),
  condition = factor(c("TNBC", "TNBC", "TNBC",
                       "Normal", "Normal", "Normal",
                       "NonTNBC", "NonTNBC", "NonTNBC",
                       "HER2", "HER2", "HER2"))
)

# Replace NA values with 0 in the count matrix
count_matrix[is.na(count_matrix)] <- 0

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_matrix, 
                              colData = sample_info, 
                              design = ~ condition)

# Filter Low-Count Genes
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep, ]

# Run DESeq
dds <- DESeq(dds)

# Variance Stabilizing Transformation
vsd <- vst(dds, blind = TRUE)

# PCA Plot
pcaData <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
pca_plot <- ggplot(pcaData, aes(PC1, PC2, color = condition)) +
  geom_point(size = 3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_minimal()
ggsave("PCA_plot.jpeg", plot = pca_plot, width = 6, height = 4)


#Heatmap of Top 20 Variable Genes
top_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 20)
heatmap_data <- assay(vsd)[top_genes, ]
pheatmap(
  heatmap_data,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  annotation_col = as.data.frame(colData(dds)["condition"]),
  filename = "Heatmap_top20_genes.jpeg"
)


# Differential Expression Analysis
res <- results(dds, contrast = c("condition", "TNBC", "Normal"))
res <- lfcShrink(dds, coef = 2, type = "apeglm")

# Save DE Results
write.csv(as.data.frame(res), "differential_expression_results.csv")

# Summary of DEGs
significant_genes <- subset(res, padj < 0.05 & !is.na(padj))
upregulated_genes <- nrow(subset(significant_genes, log2FoldChange > 0))
downregulated_genes <- nrow(subset(significant_genes, log2FoldChange < 0))
cat("Total DE genes: ", nrow(significant_genes), "\n")
cat("Up-regulated genes: ", upregulated_genes, "\n")
cat("Down-regulated genes: ", downregulated_genes, "\n")

# Volcano Plot
res$significant <- ifelse(res$padj < 0.05 & abs(res$log2FoldChange) > 1, "yes", "no")
volcano_plot <- ggplot(as.data.frame(res), aes(x = log2FoldChange, y = -log10(padj), color = significant)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("no" = "grey", "yes" = "red")) +
  theme_minimal() +
  xlab("Log2 Fold Change") +
  ylab("-Log10 Adjusted P-value")
ggsave(filename = "Volcano_plot.jpeg", plot = volcano_plot, width = 6, height = 4)

# List of conditions to compare with Normal
conditions <- c("TNBC", "NonTNBC", "HER2")

# Loop through each condition and generate volcano plot
for (condition in conditions) {
  # Perform Differential Expression Analysis
  res <- results(dds, contrast = c("condition", condition, "Normal"))
  
  # Shrink log fold changes using apeglm
  res <- lfcShrink(dds, coef = 2, type = "apeglm")
  
  # Add a column to indicate significance
  res$significant <- ifelse(res$padj < 0.05 & abs(res$log2FoldChange) > 1, "yes", "no")
  
  # Convert results to a data frame
  res_df <- as.data.frame(res)
  
  # Generate the Volcano Plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = significant)) +
    geom_point(alpha = 0.5) +
    scale_color_manual(values = c("no" = "grey", "yes" = "red")) +
    theme_minimal() +
    xlab("Log2 Fold Change") +
    ylab("-Log10 Adjusted P-value") +
    ggtitle(paste("Volcano Plot:", condition, "vs Normal"))
  
  # Save the plot
  ggsave(filename = paste0("Volcano_plot_", condition, "_vs_Normal.jpeg"), plot = volcano_plot, width = 6, height = 4)
}

# Gene Expression Plots for Selected Genes
gene_ids <- c("ENSG00000162444", "ENSG00000139618", "ENSG00000141510")
for (gene_id in gene_ids) {
  d <- plotCounts(dds, gene = gene_id, intgroup = "condition", returnData = TRUE)
  gene_expression_plot <- ggplot(d, aes(x = condition, y = count)) +
    geom_point(position = position_jitter(w = 0.1, h = 0)) +
    scale_y_log10() +
    ggtitle(paste("Expression of", gene_id)) +
    xlab("Condition") +
    ylab("Normalized Counts")
  ggsave(filename = paste0("Gene_expression_", gene_id, ".jpeg"), plot = gene_expression_plot, width = 6, height = 4)
}

# Overrepresentation Analysis
gene_list <- rownames(subset(res, padj < 0.05 & !is.na(padj)))
universe <- rownames(res)
go_enrich <- enrichGO(
  gene         = gene_list,
  universe     = universe,
  OrgDb        = org.Hs.eg.db,
  ont          = "BP",
  keyType      = "ENSEMBL",
  pAdjustMethod = "BH"
)
write.csv(as.data.frame(go_enrich), "GO_enrichment_results.csv")
```