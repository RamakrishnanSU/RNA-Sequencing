# Load necessary libraries
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
required_packages <- c("DESeq2", "ggplot2", "pheatmap", "clusterProfiler", "org.Hs.eg.db", "apeglm", "readxl")
for (pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) BiocManager::install(pkg)
}
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(clusterProfiler)
library(org.Hs.eg.db)
library(apeglm)
library(readxl)

setwd("C:/Users/ramak/Desktop/R/R")

# Load the Excel file
count_matrix <- read_excel("counts_1.xlsx", sheet = 1)

# Convert to a data frame
count_matrix <- as.data.frame(count_matrix)

# Set the second row as column names (assuming it's the header)
colnames(count_matrix) <- count_matrix[1, ]
count_matrix <- count_matrix[-1, ]

# Replace missing values in the 'Geneid' column with unique identifiers
count_matrix$Geneid[is.na(count_matrix$Geneid)] <- paste0("Gene_", seq_len(sum(is.na(count_matrix$Geneid))))

# Ensure 'Geneid' values are unique
count_matrix$Geneid <- make.unique(as.character(count_matrix$Geneid))

# Set the 'Geneid' column as row names
rownames(count_matrix) <- count_matrix$Geneid
count_matrix <- count_matrix[, -1]

# Subset only relevant numeric columns (adjust column indices as needed)
count_matrix <- count_matrix[, 6:17]

# Convert data to numeric while preserving row names
count_matrix[] <- lapply(count_matrix, as.numeric)

head(rownames(count_matrix))  # Should display gene names
head(colnames(count_matrix))  # Should display sample names

# Load sample information
sample_info <- data.frame(
  sample = c("TNBC1", "TNBC2", "TNBC3",
             "Normal1", "Normal2", "Normal3",
             "NonTNBC1", "NonTNBC2", "NonTNBC3",
             "HER21", "HER22", "HER23"),
  condition = factor(c("TNBC", "TNBC", "TNBC",
                       "Normal", "Normal", "Normal",
                       "NonTNBC", "NonTNBC", "NonTNBC",
                       "HER2", "HER2", "HER2"))
)

# Replace NA values with 0 in the count matrix
count_matrix[is.na(count_matrix)] <- 0

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_matrix, 
                              colData = sample_info, 
                              design = ~ condition)

# Filter Low-Count Genes
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep, ]

# Run DESeq
dds <- DESeq(dds)

# Variance Stabilizing Transformation
vsd <- vst(dds, blind = TRUE)

# PCA Plot
pcaData <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
pca_plot <- ggplot(pcaData, aes(PC1, PC2, color = condition)) +
  geom_point(size = 3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_minimal()
ggsave("PCA_plot.jpeg", plot = pca_plot, width = 6, height = 4)


#Heatmap of Top 20 Variable Genes
top_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 20)
heatmap_data <- assay(vsd)[top_genes, ]
pheatmap(
  heatmap_data,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = TRUE,
  annotation_col = as.data.frame(colData(dds)["condition"]),
  filename = "Heatmap_top20_genes.jpeg"
)